<!-- app/views/questionnaires/index.html.erb -->
<div class="min-h-screen bg-white" id="app">
  <!-- Header -->
  <div class="border-b border-gray-100">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-20">
        <div class="flex items-center space-x-4">
          <div class="w-10 h-10 bg-gray-900 rounded flex items-center justify-center">
            <span class="text-white font-bold text-lg">C</span>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Cogeli</h1>
            <p class="text-sm text-gray-600">Configuration fumisterie</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Container principal -->
  <div class="max-w-4xl mx-auto px-4 py-8">
    <!-- Page d'accueil -->
    <div id="home-page" class="page">
      <div class="text-center mb-16">
        <h2 class="text-4xl font-bold text-gray-900 mb-6">
          Configurateur fumisterie
        </h2>
        <p class="text-xl text-gray-600 max-w-3xl mx-auto mb-12">
          Trouvez les solutions techniques parfaitement adaptées à votre projet.
        </p>
        <button onclick="startQuestionnaire()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-8 py-4 rounded-xl text-lg">
          Commencer la configuration
        </button>
      </div>
    </div>

    <!-- Questionnaire -->
    <div id="questionnaire-page" class="page hidden">
      <!-- Progress bar -->
      <div class="mb-8">
        <div class="flex justify-between text-sm text-gray-600 mb-2">
          <span id="current-page-name">Le raccordement</span>
          <span id="progress-text">1 / 8</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 12.5%"></div>
        </div>
      </div>

      <!-- Question -->
      <div id="question-container" class="bg-white rounded-lg shadow-lg p-8">
        <h3 id="question-title" class="text-2xl font-bold text-gray-900 mb-6"></h3>
        <div id="answer-options" class="space-y-3"></div>
      </div>

      <!-- Navigation -->
      <div class="flex justify-between mt-8">
        <button id="prev-btn" onclick="previousQuestion()" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
          Précédent
        </button>
        <button id="next-btn" onclick="nextQuestion()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          Suivant
        </button>
      </div>
    </div>

    <!-- Résultats -->
    <div id="results-page" class="page hidden">
      <h2 class="text-3xl font-bold text-gray-900 mb-8">Votre configuration</h2>

      <div id="results-container" class="space-y-6">
        <!-- Les résultats seront injectés ici -->
      </div>

      <div class="mt-8 flex space-x-4">
        <button onclick="restartQuestionnaire()" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
          Nouvelle configuration
        </button>
        <button onclick="downloadPDF()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
          Télécharger PDF
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Configuration des questions
const questions = [
  {
    id: 'Q1',
    title: 'Sortie du poêle',
    page: 'Le raccordement',
    type: 'single',
    required: true,
    options: [
      { code: 'R1', label: 'ARRIERE (A)', value: 'A' },
      { code: 'R2', label: 'DESSUS (D)', value: 'D' }
    ]
  },
  {
    id: 'Q2',
    title: "S'agit-il d'une ventouse ?",
    page: 'Le raccordement',
    type: 'single',
    required: true,
    options: [
      { code: 'R1', label: 'OUI', value: 'OUI' },
      { code: 'R2', label: 'NON', value: 'NON' }
    ]
  },
  {
    id: 'Q3',
    title: 'Diamètre de raccordement',
    page: 'Le raccordement',
    type: 'single',
    required: true,
    condition: () => answers['Q2'] === 'R2', // Visible si pas ventouse
    options: [
      { code: 'R1', label: '80', value: '80' },
      { code: 'R2', label: '100', value: '100' },
      { code: 'R3', label: '130', value: '130' },
      { code: 'R4', label: '150', value: '150' },
      { code: 'R5', label: '180', value: '180' },
      { code: 'R6', label: '80/130', value: '80130' },
      { code: 'R7', label: '100/150', value: '100150' }
    ]
  },
  {
    id: 'Q4',
    title: 'Liaison entre CR et CF',
    page: 'La liaison',
    type: 'single',
    required: true,
    condition: () => answers['Q2'] === 'R2',
    options: [
      { code: 'R1', label: 'Plafond (P)', value: 'P' },
      { code: 'R2', label: 'Traversée de mur (90°)', value: '90' },
      { code: 'R3', label: 'Dans conduit (AD)', value: 'AD' }
    ]
  },
  {
    id: 'Q5',
    title: 'Type de travaux sur conduits de fumée',
    page: 'Le conduit de fumée',
    type: 'single',
    required: true,
    condition: () => answers['Q2'] === 'R2',
    options: [
      { code: 'R1', label: 'Tubage', value: 'T' },
      { code: 'R2', label: 'Création de conduit intérieur', value: 'DPI' },
      { code: 'R3', label: 'Création de conduit extérieur', value: 'DPE' },
      { code: 'R4', label: 'Création de conduit concentrique', value: 'CC' }
    ]
  },
  {
    id: 'Q6',
    title: 'Hauteur du conduit de fumée',
    page: 'Le conduit de fumée',
    type: 'single',
    required: true,
    condition: () => answers['Q2'] === 'R2',
    options: Array.from({length: 12}, (_, i) => ({
      code: `R${i+1}`,
      label: `${i+1} mètre${i > 0 ? 's' : ''}`,
      value: (i+1).toString()
    }))
  },
  {
    id: 'Q7',
    title: 'Diamètre intérieur du conduit de fumée',
    page: 'Le conduit de fumée',
    type: 'single',
    required: true,
    condition: () => answers['Q2'] === 'R2',
    options: [
      { code: 'R1', label: '80', value: '80' },
      { code: 'R2', label: '100', value: '100' },
      { code: 'R3', label: '130', value: '130' },
      { code: 'R4', label: '150', value: '150' },
      { code: 'R5', label: '180', value: '180' },
      { code: 'R6', label: '80/130', value: '80130' },
      { code: 'R7', label: '100/150', value: '100150' }
    ]
  },
  {
    id: 'Q8',
    title: 'Type conduit ou toiture',
    page: 'Le conduit de fumée',
    type: 'single',
    required: true,
    condition: () => answers['Q2'] === 'R2',
    options: [
      { code: 'R1', label: 'Conduit maçonné', value: 'CM' },
      { code: 'R2', label: 'Conduit métallique', value: 'MET' },
      { code: 'R3', label: 'Toiture terrasse 30-45°', value: 'TT' },
      { code: 'R4', label: 'Toiture ardoise ou tuiles plates', value: 'TA' },
      { code: 'R5', label: 'Toiture tuile', value: 'TTU' },
      { code: 'R6', label: 'Toiture bac acier', value: 'TBA' },
      { code: 'R7', label: 'Création extérieur', value: 'CE' }
    ]
  }
];

// État de l'application
let currentQuestionIndex = 0;
let answers = {};
let visibleQuestions = [];
let currentSessionId = null;

// Fonction pour obtenir le token CSRF Rails
function getCSRFToken() {
  const meta = document.querySelector('meta[name="csrf-token"]');
  return meta ? meta.getAttribute('content') : '';
}

// Fonctions de navigation
function showPage(pageId) {
  document.querySelectorAll('.page').forEach(page => {
    page.classList.add('hidden');
  });
  document.getElementById(pageId).classList.remove('hidden');
}

function startQuestionnaire() {
  answers = {};
  currentQuestionIndex = 0;
  currentSessionId = null;
  updateVisibleQuestions();
  showPage('questionnaire-page');
  displayQuestion();
}

function restartQuestionnaire() {
  startQuestionnaire();
}

function updateVisibleQuestions() {
  visibleQuestions = questions.filter(q => {
    if (!q.condition) return true;
    return q.condition();
  });
  console.log('Questions visibles:', visibleQuestions.map(q => q.id));
  console.log('Réponses actuelles:', answers);
}

function displayQuestion() {
  // TOUJOURS recalculer les questions visibles EN PREMIER
  updateVisibleQuestions();

  if (currentQuestionIndex >= visibleQuestions.length) {
    showResults();
    return;
  }

  const question = visibleQuestions[currentQuestionIndex];

  // Mise à jour du titre et de la page
  document.getElementById('question-title').textContent = question.title;
  document.getElementById('current-page-name').textContent = question.page;

  // Progress - recalculé avec les NOUVELLES questions visibles
  const progress = ((currentQuestionIndex + 1) / visibleQuestions.length) * 100;
  document.getElementById('progress-bar').style.width = `${progress}%`;
  document.getElementById('progress-text').textContent = `${currentQuestionIndex + 1} / ${visibleQuestions.length}`;

  // Options de réponse
  const container = document.getElementById('answer-options');
  container.innerHTML = '';

  question.options.forEach(option => {
    const label = document.createElement('label');
    label.className = 'flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50 transition';

    const isSelected = answers[question.id] === option.code;
    if (isSelected) {
      label.className += ' border-blue-600 bg-blue-50';
    }

    label.innerHTML = `
      <input type="radio"
             name="question"
             value="${option.code}"
             ${isSelected ? 'checked' : ''}
             onchange="selectAnswer('${question.id}', '${option.code}')"
             class="mr-3">
      <span class="text-lg">${option.label}</span>
    `;

    container.appendChild(label);
  });

  // Boutons navigation
  document.getElementById('prev-btn').disabled = currentQuestionIndex === 0;
  document.getElementById('next-btn').disabled = !answers[question.id];

  // MAINTENANT on vérifie avec les BONNES questions visibles
  if (currentQuestionIndex === visibleQuestions.length - 1) {
    document.getElementById('next-btn').textContent = 'Voir les résultats';
  } else {
    document.getElementById('next-btn').textContent = 'Suivant';
  }
}

function selectAnswer(questionId, answerCode) {
  answers[questionId] = answerCode;
  document.getElementById('next-btn').disabled = false;

  // Mise à jour visuelle
  document.querySelectorAll('#answer-options label').forEach(label => {
    const input = label.querySelector('input');
    if (input.value === answerCode) {
      label.className = 'flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50 transition border-blue-600 bg-blue-50';
    } else {
      label.className = 'flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50 transition';
    }
  });
}

function nextQuestion() {
  currentQuestionIndex++;
  updateVisibleQuestions(); // Recalculer APRÈS avoir incrémenté

  if (currentQuestionIndex >= visibleQuestions.length) {
    showResults();
  } else {
    displayQuestion();
  }
}

function previousQuestion() {
  if (currentQuestionIndex > 0) {
    currentQuestionIndex--;
    displayQuestion();
  }
}

// Calcul des résultats
function calculateKits() {
  const kits = [];

  // Kit ventouse
  if (answers['Q2'] === 'R1') {
    if (answers['Q1'] === 'R2') {
      kits.push({
        category: 'Kit ventouse',
        code: 'KVD',
        name: 'Kit ventouse départ dessus',
        price: 450
      });
    } else if (answers['Q1'] === 'R1') {
      kits.push({
        category: 'Kit ventouse',
        code: 'KVA',
        name: 'Kit ventouse départ arrière',
        price: 450
      });
    }
    return kits; // Si ventouse, on s'arrête là
  }

  // Raccordement (RA)
  if (answers['Q3'] && answers['Q1'] && answers['Q4']) {
    const diam = questions.find(q => q.id === 'Q3').options.find(o => o.code === answers['Q3']).value;
    const outlet = answers['Q1'] === 'R2' ? 'D' : 'A';
    const liaison = questions.find(q => q.id === 'Q4').options.find(o => o.code === answers['Q4']).value;

    kits.push({
      category: 'Raccordement',
      code: `RA${diam}${outlet}${liaison}`,
      name: `Raccordement ${diam}mm sortie ${outlet === 'D' ? 'dessus' : 'arrière'} liaison ${liaison === 'P' ? 'plafond' : liaison === '90' ? 'mur 90°' : 'direct'}`,
      price: 250
    });
  }

  // Conduit (CF)
  if (answers['Q5'] && answers['Q7'] && answers['Q6']) {
    const type = questions.find(q => q.id === 'Q5').options.find(o => o.code === answers['Q5']).value;
    const diam = questions.find(q => q.id === 'Q7').options.find(o => o.code === answers['Q7']).value;
    const height = questions.find(q => q.id === 'Q6').options.find(o => o.code === answers['Q6']).value;

    let code = '';
    let name = '';

    if (type === 'T') {
      // Tubage avec hauteurs groupées - FIX: conversion en nombre
      let heightGroup = parseInt(height) <= 6 ? '6' : height === '7' ? '8' : parseInt(height) <= 9 ? '10' : '15';
      code = `CFT${diam}-${heightGroup}`;
      name = `Conduit Tubage ${diam}mm ${heightGroup}m`;
    } else if (type === 'DPI') {
      code = `CFDPI${diam}-${height}`;
      name = `Conduit intérieur ${diam}mm ${height}m`;
    } else if (type === 'DPE') {
      code = `CFDPE${diam}-${height}`;
      name = `Conduit extérieur ${diam}mm ${height}m`;
    } else if (type === 'CC') {
      code = `CFCC${diam}-${height}`;
      name = `Conduit concentrique ${diam}mm ${height}m`;
    }

    kits.push({
      category: 'Conduit',
      code: code,
      name: name,
      price: 400 + parseInt(height) * 50
    });
  }

  // Liaison (LI)
  if (answers['Q3'] && answers['Q4'] && answers['Q5'] && answers['Q7'] && answers['Q5'] !== 'R4') {
    const diamRac = questions.find(q => q.id === 'Q3').options.find(o => o.code === answers['Q3']).value;
    const liaison = questions.find(q => q.id === 'Q4').options.find(o => o.code === answers['Q4']).value;
    const type = questions.find(q => q.id === 'Q5').options.find(o => o.code === answers['Q5']).value;
    const diamConduit = questions.find(q => q.id === 'Q7').options.find(o => o.code === answers['Q7']).value;

    kits.push({
      category: 'Liaison',
      code: `LI${diamRac}${liaison}${type}${diamConduit}`,
      name: `Liaison ${diamRac}mm vers ${type} ${diamConduit}mm`,
      price: 150
    });
  }

  // Finition haute (FH)
  if (answers['Q5'] && answers['Q7'] && answers['Q8']) {
    const type = questions.find(q => q.id === 'Q5').options.find(o => o.code === answers['Q5']).value;
    const diam = questions.find(q => q.id === 'Q7').options.find(o => o.code === answers['Q7']).value;
    const roof = questions.find(q => q.id === 'Q8').options.find(o => o.code === answers['Q8']).value;

    let roofCode = roof === 'CM' ? 'MAC' : roof === 'MET' ? 'MET' : roof === 'TT' ? 'PLAT' : roof === 'TA' ? 'ARDTP' : roof === 'TTU' ? 'TUMEC' : roof === 'TBA' ? 'ACIER' : '';

    kits.push({
      category: 'Finition haute',
      code: `FH${type}${diam}${roofCode}`,
      name: `Finition haute ${type} ${diam}mm ${roof}`,
      price: 200
    });
  }

  // Options spéciales
  if (answers['Q3'] && (answers['Q3'] === 'R6' || answers['Q3'] === 'R7')) {
    const diam = questions.find(q => q.id === 'Q3').options.find(o => o.code === answers['Q3']).value;
    kits.push({
      category: 'Option',
      code: `DEVRAC${diam}`,
      name: `DEVRAC ${diam}`,
      price: 180
    });
  }

  if (answers['Q3'] && answers['Q8'] === 'R1') {
    const diam = questions.find(q => q.id === 'Q3').options.find(o => o.code === answers['Q3']).value;
    if (['80', '100', '130', '150'].includes(diam)) {
      kits.push({
        category: 'Option',
        code: `FHREH${diam}`,
        name: `Rehausse de conduit ${diam}`,
        price: 150
      });
    }
  }

  return kits;
}

// Calcul du total
function calculateTotal() {
  const kits = calculateKits();
  return kits.reduce((total, kit) => total + kit.price, 0);
}

// Sauvegarde en base de données
async function saveToDatabase() {
  const kits = calculateKits();
  const total = calculateTotal();

  // Afficher un indicateur de chargement
  showNotification('Sauvegarde en cours...', 'info');

  try {
    const response = await fetch('/api/save_results', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': getCSRFToken()
      },
      body: JSON.stringify({
        answers: answers,
        kits: kits,
        total: total,
        save_to_db: true
      })
    });

    if (!response.ok) {
      throw new Error(`Erreur HTTP: ${response.status}`);
    }

    const data = await response.json();

    if (data.success) {
      currentSessionId = data.session_id;
      showNotification('Configuration sauvegardée avec succès!', 'success');

      // Activer le bouton d'envoi par email
      const emailBtn = document.getElementById('email-btn');
      if (emailBtn) {
        emailBtn.disabled = false;
        emailBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      }
    } else {
      throw new Error('Échec de la sauvegarde');
    }
  } catch (error) {
    console.error('Erreur de sauvegarde:', error);
    showNotification('Erreur lors de la sauvegarde. Veuillez réessayer.', 'error');
  }
}

// Génération du PDF avec WickedPDF
async function downloadPDF() {
  const kits = calculateKits();
  const total = calculateTotal();

  // Grouper les kits par catégorie pour le PDF
  const grouped = {};
  kits.forEach(kit => {
    if (!grouped[kit.category]) {
      grouped[kit.category] = [];
    }
    grouped[kit.category].push(kit);
  });

  showNotification('Génération du PDF en cours...', 'info');

  try {
    const response = await fetch('/api/generate_pdf', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': getCSRFToken()
      },
      body: JSON.stringify({
        kits: grouped,
        total: total,
        answers: answers // Envoyer les codes de réponse R1, R2, etc. pour le mapping côté serveur
      })
    });

    if (!response.ok) {
      throw new Error(`Erreur HTTP: ${response.status}`);
    }

    const blob = await response.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `configuration_cogeli_${new Date().toISOString().split('T')[0]}.pdf`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showNotification('PDF téléchargé avec succès!', 'success');
  } catch (error) {
    console.error('Erreur de génération PDF:', error);
    showNotification('Erreur lors de la génération du PDF. Veuillez réessayer.', 'error');
  }
}

// Envoi par email
async function sendByEmail() {
  const emailInput = prompt('Entrez votre adresse email:');
  if (!emailInput || !emailInput.includes('@')) {
    showNotification('Adresse email invalide', 'error');
    return;
  }

  showNotification('Envoi en cours...', 'info');

  try {
    const response = await fetch('/api/send_email', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': getCSRFToken()
      },
      body: JSON.stringify({
        email: emailInput,
        session_id: currentSessionId,
        kits: calculateKits(),
        total: calculateTotal()
      })
    });

    if (!response.ok) {
      throw new Error(`Erreur HTTP: ${response.status}`);
    }

    const data = await response.json();

    if (data.success) {
      showNotification(`Configuration envoyée à ${emailInput}`, 'success');
    } else {
      throw new Error('Échec de l\'envoi');
    }
  } catch (error) {
    console.error('Erreur d\'envoi email:', error);
    showNotification('Erreur lors de l\'envoi. Veuillez réessayer.', 'error');
  }
}

// Fonction d'affichage des notifications
function showNotification(message, type = 'info') {
  // Créer l'élément de notification
  const notification = document.createElement('div');
  notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transition-all duration-300 z-50`;

  // Style selon le type
  switch (type) {
    case 'success':
      notification.className += ' bg-green-500 text-white';
      break;
    case 'error':
      notification.className += ' bg-red-500 text-white';
      break;
    case 'info':
    default:
      notification.className += ' bg-blue-500 text-white';
      break;
  }

  notification.textContent = message;
  document.body.appendChild(notification);

  // Animation d'entrée
  setTimeout(() => {
    notification.style.opacity = '1';
    notification.style.transform = 'translateX(0)';
  }, 10);

  // Suppression automatique après 3 secondes
  setTimeout(() => {
    notification.style.opacity = '0';
    notification.style.transform = 'translateX(100%)';
    setTimeout(() => {
      document.body.removeChild(notification);
    }, 300);
  }, 3000);
}

function showResults() {
  const kits = calculateKits();
  const container = document.getElementById('results-container');

  // Sauvegarder automatiquement les résultats
  saveToDatabase();

  // Grouper par catégorie
  const grouped = {};
  let total = 0;

  kits.forEach(kit => {
    if (!grouped[kit.category]) {
      grouped[kit.category] = [];
    }
    grouped[kit.category].push(kit);
    total += kit.price;
  });

  // Afficher les résultats
  container.innerHTML = '';

  Object.keys(grouped).forEach(category => {
    const section = document.createElement('div');
    section.className = 'bg-white rounded-lg shadow-lg p-6';

    let html = `<h3 class="text-xl font-bold text-gray-900 mb-4">${category}</h3>`;

    grouped[category].forEach(kit => {
      html += `
        <div class="flex justify-between items-center py-2 border-b last:border-0">
          <div>
            <span class="font-semibold">${kit.code}</span> -
            <span class="text-gray-600">${kit.name}</span>
          </div>
          <span class="font-bold text-blue-600">${kit.price}€</span>
        </div>
      `;
    });

    section.innerHTML = html;
    container.appendChild(section);
  });

  // Total
  const totalSection = document.createElement('div');
  totalSection.className = 'bg-blue-50 rounded-lg p-6 mt-6';
  totalSection.innerHTML = `
    <div class="flex justify-between items-center">
      <span class="text-2xl font-bold text-gray-900">Total HT</span>
      <span class="text-3xl font-bold text-blue-600">${total}€</span>
    </div>
  `;
  container.appendChild(totalSection);

  showPage('results-page');
}
</script>

<style>
.page {
  animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
